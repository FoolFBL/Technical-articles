# 进程管理

由浅入深 带你学懂操作系统中的进程管理

### 什么是进程

我们编写好的代码 起初都是存储在磁盘上的静态文件 为了使它能够运行 就需要把它加载进内存中 接着CPU会读取到寄存器中并执行每一条指令  这个运行中的程序 就叫做进程

进程（Process）是计算机中的程序从磁盘中加载到内存里的一次运行过程，是系统进行资源分配和调度的基本单位。

例 QQ微信的运行   浏览器的一次搜索 

进程的结构 由数据段 程序段 进程控制块PCB组成

### 进程的状态

进程起码有三种基本状态 运行-就绪-阻塞

还有其他两种 创建 结束

运行态

- 该时刻进程一直占用CPU

就绪态

- 可运行 由于其他进程在运行而等待CPU  称为就绪态

阻塞态

- 该进程正在等待某一件事完成（如IO操作等）而暂停运行的状态称为阻塞态

创建态

- 进程正在被创建时的状态

结束态

- 进程正从系统中消失的状态





### 进程状态的切换

![image-20220511193711623](C:\Users\SUPER FBL\AppData\Roaming\Typora\typora-user-images\image-20220511193711623.png)



- 从NULL到创建状态 一个新进程被创建的第一个状态
- 从创建状态到就绪状态 当进程被创建并完成初始化后 一切就绪时 就会变成就绪状态
- 从就绪状态到运行状态 处于就绪状态中的进程被操作系统中的进程调度器选中后 就分配给CPU正式运行该进程
- 运行状态到结束状态 当进程已经运行完成或出错时 会被操作系统当做结束态处理
- 运行状态到就绪状态 处于运行状态的该进程 由于操作系统给它分配的时间片用完了 操作系统会将其转为就绪态 接着选择另外一个进程
- 运行状态到阻塞状态 当进程请求某个事件并且必须等待发生时
- 阻塞状态到就绪状态 当进程要等待的事情完成时 它就从阻塞状态变为就绪状态

如果有大量处于阻塞状态的进程 会占用我们很多的内存空间 因此通常会把阻塞状态的进程换出内存 等到事件完成后 再从硬盘换入内存

因此需要一个状态来表示进程没有占用实际的物理内存空间的情况 这个状态就是挂起状态、

分为两种

- 就绪挂起 ：进程在硬盘 但只要进入内存 立刻运行
- 阻塞挂起：进程在磁盘 并等待某个事件的发生





### 进程的控制结构

我们已经知道了进程的定义和进程的状态 那么我们来看看操作系统使用什么来控制进程的状态呢

在操作系统中 是用PCB**进程控制块数据结构来描述进程的**

在计算机中 PCB是唯一标识进程的存在 就相当于我们人类的身份证号

**PCB具体包含什么信息呢***

进程描述信息

- 进程标识符 标识各个进程 每个进程有且只有一个进程标识符 相当于id
- 用户标识符 标识进程所归属的用户 

进程控制和管理信息

- 进程当前状态 如new ready running waiting blocked 对应进程几个状态
- 进程优先级 进程抢占CPU的优先级

资源分配清单

- 有关内存地址和虚拟内存地址的信息 所打开文件的列表和所使用的文件的IO信息

CPU相关信息

- CPU中各个寄存器的值 当进程被切换时 CPU的状态信息都会被保存在相应的PCB中 以便进程重新运行时 能从断点处继续运行

PCB是如何组织的

通常是通过链表的方式进行组织 把具有相同状态的进程连接在一块 组成各种队列

如就绪队列 阻塞队列等



### 进程的控制

此时我们已经知道了进程是什么  进程的状态有哪些 并且知道了进程的控制结构 那么我们来看看到底操作系统是怎么控制进程之间的转换的

#### 创建进程

创建进程的过程如下

- 操作系统为新进程分配一个唯一的进程标识号 并申请一个空白的PCB 
- 为进程分配资源 如果此处资源不足 会在此等待
- 初始化PCB
- 如果进程的就绪队列能够接纳新进程 那么就将其插入到就绪队列中 等待运行

#### 终止进程

进程可以有三种终止方式 正常结束 异常结束 以及外界干预（被kill掉）

终止进程的过程如下

- 查找需要终止进程的PCB
- 如果处于执行状态 则立即终止该进程的执行 然后将CPU资源分配给其他进程
- 如果还有其他子进程 则应将其所有子进程终止
- 将该进程所拥有的全部资源都归还给父进程和操作系统
- 将其从其PCB所在队列中删除

#### 阻塞进程

当进程需要等待某一事件完成时 它可以调用阻塞语句 自己把自己阻塞 但只能依靠别的进程把自己唤醒

阻塞进程的过程如下

- 找到将要被阻塞的进程标识号所对应的PCB
- 如果该进程是运行状态 则保护其现场 将其状态转为阻塞状态 并停止运行
- 将该PCB插入到阻塞队列中去

#### 唤醒进程

处于阻塞状态的进程 当他们需要的某一件事已经发生时 就需要别的进程来唤醒它

唤醒进程的过程如下

- 在该事件的阻塞队列中找到相应进程的PCB
- 将其从阻塞队列转移到就绪队列中
- 把该PCB插入到就绪队列中 等待调度程序调度



### 进程的上下文切换

现在我们已经知道了什么是进程 进程有哪几种状态 进程状态是如何切换的 那么本节我们继续了解一下调度程序是如何切换运行态进程的 

各个进程之间是共享CPU资源的 在不同的时候 进程之间是需要切换的 让不同的进程在CPU中运行 **那么一个进程切换到另一个进程运行 称之为进程的上下文切换**

#### CPU的上下文切换

CPU寄存器和程序计数是CPU在运行任何任务前 必须依赖的环境 称之为CPU上下文

CPU 上下文切换就是先把前一个任务的 CPU 上下文（CPU 寄存器和程序计数器）保存起来，然后加载新任务的上下文到这些寄存器和程序计数器，最后再跳转到程序计数器所指的新位置，运行新任务。

系统内核会存储保持下来的上下文信息，当此任务再次被分配给 CPU 运行时，CPU 会重新加载这些上下文，这样就能保证任务原来的状态不受影响，让任务看起来还是连续运行。

#### 进程的上下文切换

进程是由内核管理和调度的 所以进程的切换只能发生在内核态

**进程的上下文切换不仅包含了虚拟内存、栈、全局变量等用户空间的资源，**

**还包括了内核堆栈、寄存器等内核空间的资源。**

通常会把交换的信息保存在进程的PCB中 当要运行另外一个进程时 我们需要从这个进程的PCB中取出上下文 然后恢复到CPU中 使得这个进程可以继续执行



#### 发生进程上下文切换的场景有哪些呢

- 为某进程分配的CPU时间片用光了
- 当有更高优先级的进程要运行时 低优先级的进程就要被换出
- 当进程通过sleep 给自己挂起的时候 要进行切换